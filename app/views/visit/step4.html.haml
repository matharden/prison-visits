- content_for :header do
  %h1 Your visit date and time

%p Choose the date and time you would like to visit #{visit.prisoner.prison_name}

%p.todays-date Today's date: #{Date.today.strftime('%d %b %Y')}

- start_day = Date.today+2
- date_range = start_day..start_day+28.days
- range_by_month = date_range.group_by { |d| d.beginning_of_month }

- selected_month = (Date.parse(params[:month]) if params[:month].present?) || range_by_month.keys.first

.month-selector.cf
  -# %h3= selected_month.strftime('%B')
  - range_by_month.keys.each do |month|
    = link_to month.strftime('%B'), step4_path(:anchor => month.strftime('%Y-%m-%d')), :class => ('is-active' if month == range_by_month.keys.first)

= form_for visit, url: update_step4_path, :html => { :class => 'slot-form' } do |f|

  - if f.object.errors.any?
    %div
      Your form could not be submitted. Please fix the errors below.

  .js-slotpicker
    - range_by_month.keys.each do |month|
      .slotpicker.js-tabs.cf
        .slotpicker-nav
          %h3 First, select a date below
          %ul
            - range_by_month[month].each do |date|
              %li= link_to date.strftime("%A #{date.day.ordinalize}"), "#date-#{date.strftime('%Y-%m-%d')}", :class => 'js-slotpicker-day'

        .slots
          %h3 Then select a time slot
          .slotpicker-content.js-tabs-content
            - range_by_month[month].each do |date|
              %div.js-slotpicker-options{ :id => "date-#{date.strftime('%Y-%m-%d')}" }
                = date.strftime("%A %e")
                %h4 First session
                %label.slot
                  9:30am to 11:30am
                  %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-1" }(type="checkbox" name="slot")
                %h4 Second session
                %label.slot
                  1:45pm to 3:45pm
                  %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-2" }(type="checkbox" name="slot")
                %h4 Third session
                %label.slot
                  5:15pm to 7:15pm
                  %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-3" }(type="checkbox" name="slot")

  .hidden.slotpicker-chosen
    - @slots.each_with_index do |slot, index|
      = f.fields_for :slots, slot do |builder|

        %fieldset.js-slotpicker-slot
          %legend Choice #{index+1}

          .group
            = label_tag "visit[slots][][date]", 'Date'
            = date_field_tag "visit[slots][][date]", slot.date

          .group
            = label_tag "visit[slots][][slot]", 'Slot'
            = text_field_tag "visit[slots][][slot]", slot.slot

  %br
  = f.button :Continue, :name => 'next', :value => 'continue', :class => 'button button-primary'
