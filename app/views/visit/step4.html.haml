- content_for :header do
  %h1 Your visit date and time

%p Choose the date and time you would like to visit

%p.todays-date Today's date: #{Date.today.strftime('%d %b %Y')}

%h2 #{visit.prisoner.prison_name}

- start_day = Date.today+2
- date_range = start_day..start_day+28.days
- months_in_range = date_range.map {|d| Date.new(d.year, d.month, 1) }.uniq
- selected_month = (Date.parse(params[:month]) if params[:month].present?) || months_in_range.first

.month-selector
  %h3= selected_month.strftime('%B')

  - months_in_range.reject { |m| selected_month == m }.each do |d|
    = link_to d.strftime("%B"), step4_path(:month => d.strftime('%Y-%m-%d'))

= form_for visit, url: update_step4_path, :html => { :class => 'slot-form' } do |f|

  - if f.object.errors.any?
    %div
      Your form could not be submitted. Please fix the errors below.

  .slot-picker.js-tabs.cf
    %h3 First, select a date below
    %ul.slot-picker-nav
      - date_range.each do |date|
        %li= link_to date.strftime("%A #{date.day.ordinalize}"), "#date-#{date.strftime('%Y-%m-%d')}", :class => 'js-slotpicker-day'

    .slots
      %h3 Then select a time slot
      .slot-picker-content.js-tabs-content.js-slotpicker
        - date_range.each do |date|
          %div.js-slotpicker-options{ :id => "date-#{date.strftime('%Y-%m-%d')}" }
            = date.strftime("%A %e")
            %h4 First session
            %label.slot
              9:30am to 11:30am
              %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-1" }(type="checkbox" name="slot")
            %h4 Second session
            %label.slot
              1:45pm to 3:45pm
              %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-2" }(type="checkbox" name="slot")
            %h4 Third session
            %label.slot
              5:15pm to 7:15pm
              %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-3" }(type="checkbox" name="slot")

  .hidden.slot-picker-chosen
    - @slots.each_with_index do |slot, index|
      = f.fields_for :slots, slot do |builder|

        %fieldset.js-slotpicker-slot
          %legend Choice #{index+1}

          .group
            = label_tag "visit[slots][][date]", 'Date'
            = date_field_tag "visit[slots][][date]", slot.date

          .group
            = label_tag "visit[slots][][slot]", 'Slot'
            = text_field_tag "visit[slots][][slot]", slot.slot

  %br
  = f.button :Continue, :name => 'next', :value => 'continue', :class => 'button button-primary'
