- content_for :header do
  %h1 Your visit date and time

:javascript
  var slots = #{visit.slots.to_json};

%p
  Now choose 
  %strong up to three 
  visit times that will be sent to the prisonâ€™s booking team to confirm availablity.

- start_day = Date.today+2
- date_range = start_day..start_day+28.days
- range_by_month = date_range.group_by { |d| d.beginning_of_month }
- number_of_slots = 3

.selected-slots
  %h3 Selected visit times
  %p You can remove a time using the 'x' button
  %ul
    - (1..number_of_slots).each_with_index do |i|
      %li
        %a.js-remove-slot(href="#") &times;
        %p.date
        %p.time
        %p.placeholder
          = [:first, :second, :third][i-1].capitalize
          visit time

.slot-chooser.js-tabs
  %h2
    %small.todays-date
      Today:
      %strong #{Date.today.day.ordinalize} #{Date.today.strftime('%b %Y')}
    #{visit.prisoner.prison_name} visitors centre

  .month-selector
    %ul.js-tabs-nav
      - range_by_month.keys.each do |month|
        %li= link_to month.strftime('%B'), month.strftime('#month-%Y-%m-%d')

  = form_for visit, url: update_step4_path, :html => { :class => 'slot-form cf' } do |f|

    - if f.object.errors.any?
      %div
        Your form could not be submitted. Please fix the errors below.

    .slotpicker-wrapper.js-slotpicker.js-tabs-content{ :'data-optionlimits' => number_of_slots }
      - range_by_month.keys.each do |month|
        .slotpicker.js-tabs.cf{ :id => month.strftime('month-%Y-%m-%d') }(data-focusfirst="true")
          .slotpicker-nav
            %h3 First, select a date below
            %ul.js-tabs-nav
              - range_by_month[month].each do |date|
                %li= link_to date.strftime("%A #{date.day.ordinalize} <span>%B</span>").html_safe, date.strftime('#date-%Y-%m-%d'), :class => 'js-slotpicker-day'

          .slots
            %h3 Then select a time slot
            .slotpicker-content.js-tabs-content
              - range_by_month[month].each do |date|
                %div.js-slotpicker-options{ :id => "date-#{date.strftime('%Y-%m-%d')}" }
                  %h4 First session
                  %label.slot
                    9:30am to 11:30am
                    %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-1" }(type="checkbox" name="slot")
                  %h4 Second session
                  %label.slot
                    1:45pm to 3:45pm
                    %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-2" }(type="checkbox" name="slot")
                  %h4 Third session
                  %label.slot
                    5:15pm to 7:15pm
                    %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-3" }(type="checkbox" name="slot")

    .hidden.slotpicker-chosen
      - @slots.each_with_index do |slot, index|
        = f.fields_for :slots, slot do |builder|

          %fieldset.js-slotpicker-slot
            %legend Choice #{index+1}

            .group
              = label_tag "visit[slots][][date]", 'Date'
              = date_field_tag "visit[slots][][date]", slot.date

            .group
              = label_tag "visit[slots][][slot]", 'Slot'
              = text_field_tag "visit[slots][][slot]", slot.slot

    %br
    .actions
      = f.button :Continue, :name => 'next', :value => 'continue', :class => 'button button-primary'
