- content_for :header do
  %h1 Your visit date and time

%p
  Choose the date first, then choose the time youâ€™d like to visit. You can choose up to three possible dates and times. Use the arrows to put your visit choices in the order that suits you best.

- if visit.slots.any? {|s| s.errors.any?}
  #error-summary.validation-summary.group(role="alert" tabindex="-1" aria-labelledby="error-heading")
    %h2#error-heading You need to fix the errors on this page before continuing.
    %p You need to choose date(s) and time(s) for your visit to continue.

#calendar.fc-content
  %table.fc-border-separate(style='width:100%')
    %caption.step_prompt First select a date
    %thead
      %tr
        - [:Mon,:Tue,:Wed,:Thu,:Fri,:Sat,:Sun].each do |d|
          %th.fc-day-header= d

      - weeks.each do |week|
        %tr
          - week[1].each do |day|
            %td.fc-day.fc-widget-content{ :'data-date' => day, :class => day_classes(day) }
              .fc-day-number= day.strftime('%e')
              .fc-day-content
                - if tag_with_month? day
                  .fc-tag= day.strftime('%b')

.slots.js-slotpicker{ :'data-optionlimits' => number_of_slots }
  %h2.step_prompt Now select a time
  .js-slotpicker-options.day-slots#in-the-past
    %p It is not possible to book a visit in the past
  .js-slotpicker-options.day-slots#too-far-ahead
    %p You can only book a visit in the next 28 days
  .js-slotpicker-options.day-slots#booking-gap
    %p You can only book a visit 3 days in advance

  - range_by_month.keys.each do |month|
    .slot__month{ :id => month.strftime('month-%Y-%m-%d') }(data-focusfirst="true")

      - range_by_month[month].each do |date|
        .js-slotpicker-options.day-slots.cf{ :id => "date-#{date.strftime('%Y-%m-%d')}" }
          - if visiting_slots.keys.include?(date.strftime('%a').downcase.to_sym)
            %h4= date.strftime("%A %e %B")
            - visiting_slots[date.strftime('%a').downcase.to_sym].each_with_index do |slot, index|
              - slot_start = Time.strptime(slot[0].to_s, '%H%M')
              - slot_end = Time.strptime(slot[1].to_s, '%H%M')
              %label.slot
                %strong= slot_start.strftime("%l:%M%P")
                %span.duration= (slot_end - slot_start).duration
                %input.js-slotpicker-option{ :value => "#{date.strftime('%Y-%m-%d')}-#{slot[0]}-#{slot[1]}" }(type="checkbox" name="slot")

          - else
            %p There are no sessions available on #{date.strftime('%A')}s.

.selected-slots.js-selected-slots
  %h2.step_prompt Your visit times
  %ul
    - (1..number_of_slots).each_with_index do |i|
      %li
        - unless i == 1
          %a.slot-promote.js-promote-slot{ :href => "##{i}" }
        %a.slot-remove.js-remove-slot(href="#") &times;
        .slot-position= i
        %p.date
        %p.time
        -# %p.placeholder #{[:First, :Second, :Third][i-1]} choice


= form_for visit, url: update_visit_details_path, :html => { :class => 'slot-form' } do |f|

  .js-slotpicker-chosen
    - @slots.each_with_index do |slot, index|
      = f.fields_for :slots, slot do

        .group.js-slotpicker-slot
          %label Option #{index+1}

          %select(name='visit[slots][][slot]')
            %option(value='') none
            - bookable_range.each do |date|
              -# Only bookable days
              - if bookable_week_days.include?(date.wday)
                - weekday = date.strftime('%a').downcase.to_sym
                - if visiting_slots.keys.include?(weekday)
                  - visiting_slots[weekday].each_with_index do |slot, i|
                    - value = [date.strftime('%Y-%m-%d'), slot.join('-')].join('-')
                    - selected = value == current_slots[index-1] ? 'selected' : nil
                    %option{ value: value, selected: selected }= date.strftime('%A, %e %B - ') + Time.strptime(slot[0].to_s, '%H%M').strftime('%l:%M%P')

  .actions
    = link_to 'Cancel and delete all details', abandon_path, :class => 'pull-right', :'data-confirm' => "Are you sure you wish to cancel this visit request?\r\rThis will delete all the information you have entered"
    = f.button :Continue, :name => 'next', :value => 'continue', :class => 'button button-primary js-submit'

:javascript
  pvbe = {
    bookable_from:      '#{bookable_from.strftime('%Y-%m-%d')}',
    current_slots:      #{current_slots.to_json},
    bookable_week_days: #{bookable_week_days.to_json},
    bookable_dates:     #{bookable_dates.to_json}
  }
