- content_for :header do
  %h1 Check your request

- content_for :javascript do
  :javascript
    $("#send-request-form").submit(function() {
      ga('send', 'event', 'visit', 'prison_name', visitMetadata.prison_name);
      ga('send', 'event', 'visit', 'slot', 'size', visitMetadata.number_of_slots);
      ga('send', 'event', 'visit', 'prisoner', 'age', visitMetadata.prisoner_age);
      ga('send', 'event', 'visit', 'visitor', 'age', visitMetadata.visitor_age);
      ga('send', 'event', 'visit', 'adult_visitors', 'number', visitMetadata.number_of_adult_visitors);
      ga('send', 'event', 'visit', 'child_visitors', 'number', visitMetadata.number_of_child_visitors);
      visitMetadata.slot_times.forEachWithIndex(function(t, i) {
        ga('send', 'event', 'visit', 'slot_times_' + i, t);
      });
      visitMetadata.slot_weekdays.forEachWithIndex(function(w, i) {
        ga('send', 'event', 'visit', 'slot_weekdays_' + i, w)
      });
    });

%p Check all the details on this page carefully before clicking 'Send request'

.divider
  .edit-link= link_to 'Edit these prisoner details', prisoner_details_path
  %h2 Prisoner details
  %p
    %big
      %strong #{visit.prisoner.first_name} #{visit.prisoner.last_name}
  %p
    Date of birth:
    %strong= visit.prisoner.date_of_birth.strftime("%e %B %Y")
  - if visit.prisoner.number.present?
    %p
      Prisoner number:
      %strong #{visit.prisoner.number}
  %p
    Prison:
    %strong #{visit.prisoner.prison_name}

.divider
  .edit-link= link_to 'Edit these visitor details', visitor_details_path
  %h2 Visitor details
  - visit.visitors.each_with_index do |visitor, i|
    - if visitor.first_name.present? || visitor.last_name.present?
      %p
        Visitor #{i+1}:
        %strong #{visitor.first_name} #{visitor.last_name}

.divider
  .edit-link= link_to 'Edit these visit times', choose_date_and_time_path
  %h2 Chosen visit times
  %ul.unstyled-list
    - visit.slots.each do |slot|
      - if slot.date.present?
        %li
          - slot_date = Date.parse(slot.date)
          %strong= slot_date.strftime("%A %e %B")
          \ -
          = display_slot_and_duration slot.times

.actions.divider
  = link_to 'Cancel and delete all details', abandon_path, :class => 'pull-right', :'data-confirm' => "Are you sure you wish to cancel this visit request?\r\rThis will delete all the information you have entered"
  = button_to 'Send request', update_check_your_request_path, class: 'button button-primary', form: { id: 'send-request-form' }
.hidden
  #metadata-prison-name
    = visit.prisoner.prison_name
  #metadata-number-of-visiting-slots
    = visit.slots.size
  - visit.slots.each_with_index do |s, i|
    - unless s.date.empty?
      %div{id: "metadata-slot-times-#{i}"}
        = s.times
      %div{id: "metadata-slot-weekday-#{i}"}
        = s.weekday
  #metadata-prisoner-age
    = visit.prisoner.age
  #metadata-visitor-age
    = visit.visitors.first.age
  #metadata-number-of-adult-visitors
    = visit.visitors.count { |v| v.adult? }
  #metadata-number-of-child-visitors
    = visit.visitors.count { |v| v.child? }
:ruby
  haml_io << "<script>\n"
  haml_io << "visitMetadata = "
  haml_io << GoogleAnalyticsAdapter.new(visit).to_json
  haml_io << ";"
  haml_io << "</script>\n"
